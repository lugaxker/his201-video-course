# Chapitre 9 : Les premiers ennuis techniques (2)

L'afflux d'activité faisant suite au grand slashdotting de juillet 2010 permet à Bitcoin de prendre son premier envol, tant au niveau du prix que du minage. Cependant, il s'accompane également d'un certain nombre d'ennuis techniques, et notamment de la découverte de plusieurs vulnérabilités dans le logiciel. Une plus grande popularité implique en effet à la fois un nombre plus important de personnes qui inspectent le code et une probabilité plus élevée d'anomalie de fonctionnement. En l'espace de deux mois, ce sont ainsi 8 sous-versions du logiciel qui sont publiées !

Cette charge de travail met Satoshi Nakamoto sous pression. Le 18 juillet, il confie à Martti Malmi en privé qu'il « perd la tête tellement il y a de choses à faire ».

![](img/jeff-garzik-2013.jpg) Jeff Garzik en 2013 (source : Benson Samuel)

Toutefois, le créateur de Bitcoin n'est pas seul à travailler sur le code. Il peut compter sur Gavin Andresen, arrivé en juin, qui s'implique de plus en plus dans le développement. Il y a aussi les personnes qui sont curieuses de la façon dont fonctionne le système et qui signalent les problèmes qu'elles rencontrent, à l'instar de Christian Decker ou de Michael Marquardt, plus connu sous le pseudonyme de Theymos. Satoshi est également épaulé par les mineurs, qui modifient le code pour trouver des moyens d'optimiser la génération d'unités, comme ArtForz — le gestionnaire de la première ferme de minage — ou le développeur allemand Nils Schneider, alias tcatm. On peut enfin citer Jeff Garzik, qui est un développeur américain, contributeur dans le monde du logiciel libre et notamment pour la distribution Red Hat, et qui est un libertarien adepte de l'école autrichienne d'économie. Ce dernier découvre Bitcoin avec l'article publié sur Slashdot et s'investit presque immédiatement.

Le premier objectif de Satoshi est de rendre le logiciel et le protocole plus sûrs, pour faire face à l'accroissement récent de l'utilisation. Avec Gavin Andresen, ils envisagent les diverses attaques qui pourraient avoir lieu — notamment les attaques par déni de service — et s'évertuent à corriger les vulnérabilités découvertes. C'est ainsi qu'un système de checkpoints est ajouté le 17 juillet, interdisant à la chaîne de blocs d'être réécrite avant une certaine date, et que la notion de travail est intégrée au protocole le 25 juillet pour affiner le mécanisme de sélection de la chaîne correcte par les nœuds.

Gavin et Satoshi corrigent également plusieurs bugs. Le principal est le « 1 RETURN bug », une vulnérabilité dans le système de script qui rend possible la dépense de bitcoins à partir de n'importe quelle adresse grâce à un script spécifique. Cette vulnérabilité est signalée par ArtForz le 28 juillet, qui au lieu d'exploiter la faille et de s'enrichir secrètement, choisit de faire part de sa découverte à Satoshi et à Gavin. Satoshi s'empresse d'inclure la correction dans le logiciel et recommande à tous les utilisateurs de se mettre à niveau. Bitcoin échappe ainsi au pire. Cette vulnérabilité sera plus tard enregistrée sous l'identifiant CVE-2010-5141.

Le second objectif est d'améliorer les performances du système, en apportant des modifications au protocole ou en optimisant le fonctionnement du logiciel. C'est dans cette catégorie que rentre l'ajout des codes opération OP_NOP au système de script interne, réalisé discrètement par Satoshi le 29 juillet, avec pour seul commentaire le mot « expansion ». Ces codes opération sont des instructions muettes qui n'ont aucun effet si elles sont présentes dans un script, mais qui n'invalident pas la transaction non plus. Par conséquent, on peut modifier le comportement de ces instructions sans rendre les scripts incompatibles avec une ancienne version du protocole, d'où le commentaire de Satoshi. Ces codes opération permettront notamment de procéder à ce qu'on appellera des « soft forks » en 2015 et 2016, en transformant deux de ces instructions en OP_CHECKLOCKTIMEVERIFY et OP_CHECKSEQUENCEVERIFY.

Les mineurs partagent également leurs découvertes pour améliorer, directement ou indirectement, la génération de bitcoins avec le logiciel principal. Tout d'abord, l'optimisation personnelle de Laszlo est intégrée au logiciel dès le 6 juillet. Ensuite, la mise en cache du contexte pour la fonction de hachage SHA-256 de Nils Schneider et l'optimisation du calcul par BlackEye sont ajoutées au logiciel le 29 juillet. Enfin, la parallélisation du calcul sur un seul processeur proposée par Nils Schneider est intégrée le 15 août dans le code.

Cet élan d'innovation est pourtant terni par un évènement qui se produit lors du mois d'août, appelé le value overflow incident, qui perturbe le réseau pendant une quinzaine d'heure. Le 15 août 2010 vers 17 heures, une transaction créant plus de 184 milliards de bitcoins est incluse dans un bloc ajouté à la chaîne. Cette émission extraordinairement élevée exploite une vulnérabilité de dépassement de mémoire (ou overflow) à l'endroit de la représentation des quantités : l'attaquant a créé deux sorties transactionnelles d'environ 92 milliards de bitcoins, ce qui correpond à un montant proche du maximum d'unités pouvant être représentant par un entier signé sur 64 bits.

Une heure plus tard, le problème est repéré par Jeff Garzik, qui avertit la communauté sur le forum en signalant l'existence d'un « bloc étrange ». La réaction de Satoshi a lieu vers 21 heures : il publie une modification préliminaire du code et conseille aux gens d'« arrêter de générer » des blocs. Après avoir fait quelques révisions et les avoir téléversées sur SourceForge, il finit par publier un correctif pour Windows, Linux et Mac vers minuit. Ce correctif permet aux mineurs de rejeter la transaction incriminée comme invalide et de créer une branche alternative qui ne la contient pas. Le premier bloc de cette branche est miné dans la foulée.

Le lendemain matin, peu après 8 heures, la situation conflictuelle est résolue. La chaîne correcte devient plus longue que l'autre, ce qui fait tous les nœuds doivent alors la suivre, qu'ils appliquent le correctif ou non. Cet incident a perturbé l'activité du réseau pendant environ 15 heures, mais la réactivité de la communauté a été exemplaire.

Après la découverte du 1 RETURN bug en juillet, Satoshi a fait tout son possible pour prémunir le réseau contre les accidents du même type. Le 3 août, il a ainsi ajouté au logiciel un mécanisme d'avertissement s'activant en cas de scission de la chaîne. Toutefois, ce mécanisme ne s'avère pas utile pour détecter le bug de dépassement de mémoire qui se manifeste le 15, ce qui pousse Satoshi à développer un mécanisme plus évolué.

Dans les jours qui suivent l'incident, Satoshi construit ainsi un système d'alerte effectif sur le réseau, qui lui permet, à l'aide d'une clé privée, d'avertir les nœuds en cas de problème technique et de suspendre quelques commandes de l'API. Le 27 août, le système d'alerte est intégré officiellement au logiciel, mais la possibilité de suspension des fonctionnalités sera retirée en décembre. Dans les années qui suivront, le système d'avertissement servira à plusieurs reprises, notamment pour un embranchement accidentel en 2013, avant d'être définitivement retiré du logiciel en 2017.

Un autre élément qui s'inscrit dans la volonté d'améliorer le protocole pour le rendre résistant aux attaques est l'ajout de la limite de taille des blocs. Cette limite est un paramètre qui restreint la capacité transactionnelle du système, en imposant à chaque bloc d'être plus petit que cette taille. Elle a pour objectif initial d'empêcher les attaques par déni de service contre le réseau.

Ce paramètre est ajouté discrètement au code par Satoshi le 15 juillet sous la forme de la constante MAX_BLOCK_SIZE, qui est alors fixée à 1 mégaoctet. La programmation de la mise en place de la contrainte est réalisée le 7 septembre par le créateur de Bitcoin, toujours sans annonce publique de sa part. L'entrée en vigueur de la taille limite a lieu le 12 septembre, au bloc 79 400. Cette limitation est alors tout à fait bénigne : elle autorise un débit de 7 transactions classiques par seconde, ce qui est largement assez pour supporter l'activité économique de l'époque, même après le slashdotting.

Bien que Satoshi n'ait pas mentionné son existence, la limite de taille des blocs induit progressivement une réaction au sein de la comunauté. Elle affecte tout particulièrement Jeff Garzik, qui déclare être « beaucoup plus préoccupé par le passage à l'échelle que par la coupure \[de Bitcoin\] par un État » et qui demande comment il est possible de « vendre le bitcoin à des investisseurs sérieux, avec des limitations intégrées telles que la limite de 463 transactions par minute ». Par conséquent, le 3 octobre, il propose un correctif sur le forum pour élever la limite de taille des blocs à 7,2 mégaoctets afin d'« égaler le taux transactionnel moyen de PayPal ». Theymos lui répond en disant que « l'application de ce correctif \[le\] rendra incompatible avec les autres clients Bitcoin ». Ce message est approuvé par Satoshi Nakamoto qui recommande de pas utiliser le correctif et qui déclare — je cite : « Nous pouvons introduire un changement plus tard si nous en avons besoin. » Ce dernier précisera sa pensée le lendemain en donnant la marche à suivre pour réaliser un tel changement du protocole.

Cette discussion marque le début du débat sur la scalabilité, qui finira par dégénérer en une véritable guerre civile entre 2015 et 2017, connue sous le nom de guerre des blocs.

En septembre, Satoshi inaugure aussi une nouvelle notion dans le code : celle des transactions non standardes. Celles-ci sont des transactions que les nœuds configurés par défaut ne relaient pas, ne conservent pas dans leurs mempools et n'incluent pas dans les blocs qu'ils produisent. Toutefois, ces transactions restent tout à fait valides aux yeux du protocole, et les blocs en contenant sont acceptés par l'entièreté du réseau.

Cette distinction normative permet de limiter l'exploitation d'éventuelles vulnérabilités dans le système de script de Bitcoin, qui est assez riche et qui n'a pas été assez examiné, au prix d'une restriction temporaire de la programmabilité. À ce moment-là, deux types de script de sortie sont identifiés comme standards par le réseau : la réception par clé publique, employée par les mineurs et pour les transferts par adresse IP ; et la réception par empreinte de clé publique, utilisée pour les transferts par adresse Bitcoin.

Le 7 septembre, Satoshi inclut ainsi une limitation imposant aux transactions de ne pas être trop grosses, ni de contenir trop d'opérateurs de signature. Il s'agit, comme il l'explique, d'une application sommaire de la distinction. Cette dernière sera entérinée formellement trois mois plus tard par Gavin Andresen, qui ajoutera au code la fonction « IsStandard », une fonction vérifiant le caractère standard d'une transaction. L'accès à la programmabilité sera lui réintroduit en 2012 par le biais de l'intégration de Pay to Script Hash dans le protocole.

À la fin de l'été 2010, le logiciel a donc considérablement évolué, sous l'influence d'un travail de développement intense. Cela a pour effet d'ouvrir la voie à une professionalisation du minage, qui ne manque pas de se produire durant l'automne.
